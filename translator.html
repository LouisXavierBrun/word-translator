<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Multilingual Translator Word</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 300;
        }

        .content {
            padding: 30px;
        }

        .language-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 25px;
        }

        .language-option {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .language-option:hover {
            background-color: #f5f5f5;
        }

        .language-option input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }

        .language-option label {
            cursor: pointer;
            font-size: 0.9em;
            user-select: none;
        }

        .controls {
            margin-bottom: 25px;
        }

        .option-group {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .option-group h3 {
            margin: 0 0 10px 0;
            font-size: 1em;
            color: #555;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .checkbox-option input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.1);
        }

        .checkbox-option label {
            cursor: pointer;
            font-size: 0.9em;
        }

        .translate-btn, .export-btn {
            width: 100%;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .translate-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .export-btn {
            background: linear-gradient(45deg, #FF9800, #F57C00);
        }

        .translate-btn:hover, .export-btn:hover {
            transform: translateY(-2px);
        }

        .translate-btn:hover {
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .export-btn:hover {
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.3);
        }

        .translate-btn:disabled, .export-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress-container {
            display: none;
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9em;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .flag {
            margin-right: 5px;
            font-size: 1.1em;
            display: none;
        }

        .api-config {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            font-weight: 500;
            color: #555;
        }

        .input-group input[type="password"],
        .input-group select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e1e1e1;
            border-radius: 6px;
            font-size: 0.9em;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .input-group input[type="password"]:focus,
        .input-group select:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .api-status {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            display: none;
        }

        .api-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .api-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .api-status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .ssml-export {
            background: #fff3e0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #FF9800;
        }

        .ssml-export h4 {
            margin: 0 0 10px 0;
            color: #E65100;
            font-size: 0.9em;
        }

        .ssml-export p {
            margin: 0;
            font-size: 0.85em;
            color: #666;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåç Multilingual Translator</h1>
        </div>
        
        <div class="content">
            <div class="language-grid">
                <div class="language-option">
                    <input type="checkbox" id="fr" value="fr" checked>
                    <label for="fr">French</label>
                </div>
                <div class="language-option">
                    <input type="checkbox" id="de" value="de" checked>
                    <label for="de">German</label>
                </div>
                <div class="language-option">
                    <input type="checkbox" id="it" value="it" checked>
                    <label for="it">Italian</label>
                </div>
                <div class="language-option">
                    <input type="checkbox" id="es" value="es" checked>
                    <label for="es">Spanish</label>
                </div>
                <div class="language-option">
                    <input type="checkbox" id="pt" value="pt" checked>
                    <label for="pt">Portuguese</label>
                </div>
                <div class="language-option">
                    <input type="checkbox" id="ru" value="ru" checked>
                    <label for="ru">Russian</label>
                </div>
                <div class="language-option">
                    <input type="checkbox" id="el" value="el" checked>
                    <label for="el">Greek</label>
                </div>
                <div class="language-option">
                    <input type="checkbox" id="hu" value="hu" checked>
                    <label for="hu">Hungarian</label>
                </div>
                <div class="language-option">
                    <input type="checkbox" id="pl" value="pl" checked>
                    <label for="pl">Polish</label>
                </div>
                <div class="language-option">
                    <input type="checkbox" id="fa" value="fa" checked>
                    <label for="fa">Farsi</label>
                </div>
                <div class="language-option">
                    <input type="checkbox" id="ar" value="ar">
                    <label for="ar">Arabic</label>
                </div>
                <div class="language-option">
                    <input type="checkbox" id="tr" value="tr">
                    <label for="tr">Turkish</label>
                </div>
            </div>

            <div class="controls">
                <div class="option-group">
                    <h3>Azure Translator (Optional)</h3>
                    <div class="api-config">
                        <div class="input-group">
                            <label for="azureApiKey">API Key:</label>
                            <input type="password" id="azureApiKey" placeholder="Enter your Azure API key (optional)" />
                        </div>
                        <div class="input-group">
                            <label for="azureRegion">Region:</label>
                            <select id="azureRegion">
                                <option value="westeurope">West Europe</option>
                                <option value="eastus">East US</option>
                                <option value="westus2">West US 2</option>
                                <option value="southeastasia">Southeast Asia</option>
                                <option value="northeurope">North Europe</option>
                                <option value="centralus">Central US</option>
                            </select>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" id="saveApiKey">
                            <label for="saveApiKey">Remember my API key (stored locally)</label>
                        </div>
                        <div class="api-status" id="apiStatus"></div>
                    </div>
                </div>
                
                <div class="option-group">
                    <h3>Translation Options</h3>
                    <div class="checkbox-option">
                        <input type="checkbox" id="preserveFormat" checked>
                        <label for="preserveFormat">Preserve layout</label>
                    </div>
                    <div class="checkbox-option">
                        <input type="checkbox" id="redText" checked>
                        <label for="redText">Translated text in red</label>
                    </div>
                    <div class="checkbox-option">
                        <input type="checkbox" id="newPage" checked>
                        <label for="newPage">New page per language</label>
                    </div>
                </div>
                
                <div class="option-group">
                    <h3>SSML Export Options</h3>
                    <div class="ssml-export">
                        <h4>üé§ Azure Speech Service</h4>
                        <p>Export the entire document as a single SSML text file. Each language section will be read with its specific voice, with English announcements between languages.</p>
                    </div>
                </div>
            </div>

            <button class="translate-btn" onclick="startTranslation()">
                üöÄ Start Translation
            </button>
            
            <button class="export-btn" onclick="exportSSMLFile()" id="exportBtn">
                üìÑ Export SSML File
            </button>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText"></div>
            </div>

            <div class="status" id="status"></div>
        </div>
    </div>

    <script>
        // Languages with Azure Speech Service voices and custom prosody settings
        const languages = {
            'fr': { 
                name: 'French', 
                iso: 'FR', 
                ssmlLang: 'fr-FR', 
                voice: 'fr-FR-VivienneMultilingualNeural',
                prosody: 'rate="-3.00%"'
            },
            'de': { 
                name: 'German', 
                iso: 'DE', 
                ssmlLang: 'de-DE', 
                voice: 'de-DE-SeraphinaMultilingualNeural',
                prosody: ''
            },
            'it': { 
                name: 'Italian', 
                iso: 'IT', 
                ssmlLang: 'it-IT', 
                voice: 'it-IT-GiuseppeMultilingualNeural',
                prosody: 'pitch="low"'
            },
            'es': { 
                name: 'Spanish', 
                iso: 'ES', 
                ssmlLang: 'es-ES', 
                voice: 'es-ES-XimenaMultilingualNeural',
                prosody: 'pitch="low"'
            },
            'pt': { 
                name: 'Portuguese', 
                iso: 'PT', 
                ssmlLang: 'pt-PT', 
                voice: 'pt-PT-RaquelNeural',
                prosody: ''
            },
            'ru': { 
                name: 'Russian', 
                iso: 'RU', 
                ssmlLang: 'ru-RU', 
                voice: 'ru-RU-DmitryNeural',
                prosody: ''
            },
            'el': { 
                name: 'Greek', 
                iso: 'EL', 
                ssmlLang: 'el-GR', 
                voice: 'el-GR-NestorNeural',
                prosody: ''
            },
            'hu': { 
                name: 'Hungarian', 
                iso: 'HU', 
                ssmlLang: 'hu-HU', 
                voice: 'hu-HU-TamasNeural',
                prosody: ''
            },
            'pl': { 
                name: 'Polish', 
                iso: 'PL', 
                ssmlLang: 'pl-PL', 
                voice: 'pl-PL-MarekNeural',
                prosody: 'rate="-2.00%"'
            },
            'fa': { 
                name: 'Farsi', 
                iso: 'FA', 
                ssmlLang: 'fa-IR', 
                voice: 'fa-IR-FaridNeural',
                prosody: ''
            },
            'ar': { 
                name: 'Arabic', 
                iso: 'AR', 
                ssmlLang: 'ar-SA', 
                voice: 'ar-SA-HamedNeural',
                prosody: ''
            },
            'tr': { 
                name: 'Turkish', 
                iso: 'TR', 
                ssmlLang: 'tr-TR', 
                voice: 'tr-TR-AhmetNeural',
                prosody: ''
            }
        };

        // English announcer voice configuration
        const englishAnnouncer = {
            voice: 'en-GB-RyanNeural',
            prosody: 'rate="-2.00%" pitch="low"'
        };

        // Euronews URL mapping
        const euronewsUrls = {
            'en': 'euronews.com',
            'fr': 'euronews.fr',
            'de': 'euronews.de',
            'it': 'euronews.it',
            'es': 'euronews.es',
            'pt': 'euronews.pt',
            'ru': 'ru.euronews.com',
            'hu': 'euronews.hu',
            'el': 'gr.euronews.com',
            'pl': 'pl.euronews.com',
            'ar': 'arabic.euronews.com',
            'fa': 'parsi.euronews.com',
            'tr': 'tr.euronews.com'
        };

        // Clean text by removing EN line and adapting URLs
        function processTextForTranslation(text, targetLang) {
            // Remove standalone "EN" line at the beginning
            let processedText = text.replace(/^EN\s*\n?/m, '').trim();
            
            // Replace any euronews URL (with or without subdomain) with language-specific version
            if (euronewsUrls[targetLang]) {
                // Match any euronews URL pattern (with or without subdomain)
                processedText = processedText.replace(/(?:https?:\/\/)?(?:[a-z]+\.)?euronews\.com/g, euronewsUrls[targetLang]);
            }
            
            return processedText;
        }

        // Apply URL adaptation to translated text
        function adaptEuronewsUrls(text, targetLang) {
            if (euronewsUrls[targetLang]) {
                // Replace any euronews URL pattern in translated text
                return text.replace(/(?:https?:\/\/)?(?:[a-z]+\.)?euronews\.com/g, euronewsUrls[targetLang]);
            }
            return text;
        }

        // Clean text for SSML (escape XML entities)
        function cleanTextForSSML(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
        }

        // Generate SSML section for a language
        function generateLanguageSSML(text, langCode) {
            const config = languages[langCode];
            if (!config) {
                console.error(`Configuration not found for language: ${langCode}`);
                return `<!-- Error: Configuration not found for ${langCode} -->`;
            }
            
            const cleanText = cleanTextForSSML(text);
            
            // Create prosody tag if prosody settings exist
            let contentWithProsody = cleanText;
            if (config.prosody) {
                contentWithProsody = `<prosody ${config.prosody}>${cleanText}</prosody>`;
            }
            
            return `<voice name="${config.voice}">${contentWithProsody}</voice>`;
        }

        // Generate English announcement
        function generateAnnouncementSSML(languageName) {
            const announcement = `Now in ${languageName}`;
            const cleanAnnouncement = cleanTextForSSML(announcement);
            return `<voice name="${englishAnnouncer.voice}"><prosody ${englishAnnouncer.prosody}>${cleanAnnouncement}</prosody></voice>`;
        }

        // Export single SSML file from document
        async function exportSSMLFile() {
            const button = document.getElementById('exportBtn');
            button.disabled = true;
            button.textContent = 'üìÑ Generating SSML...';

            try {
                let ssmlContent = '';
                const extractedLanguages = [];

                await Word.run(async (context) => {
                    // Get all content from the document
                    const body = context.document.body;
                    body.load("text");
                    await context.sync();
                    
                    const fullText = body.text;
                    
                    // Start SSML document
                    ssmlContent = '<?xml version="1.0" encoding="UTF-8"?><speak xmlns="http://www.w3.org/2001/10/synthesis" xmlns:mstts="http://www.w3.org/2001/mstts" xmlns:emo="http://www.w3.org/2009/10/emotionml" version="1.0" xml:lang="en-US">';
                    
                    // Extract English content (before any language marker)
                    const firstLanguageMatch = fullText.match(/\n\n=== [A-Z]+ ===\n\n/);
                    if (firstLanguageMatch) {
                        const englishContent = fullText.substring(0, firstLanguageMatch.index).trim();
                        if (englishContent) {
                            const processedEnglish = processTextForTranslation(englishContent, 'en');
                            if (processedEnglish) {
                                const cleanEnglish = cleanTextForSSML(processedEnglish);
                                ssmlContent += `<voice name="${englishAnnouncer.voice}"><prosody ${englishAnnouncer.prosody}>${cleanEnglish}</prosody></voice>`;
                                extractedLanguages.push('EN');
                            }
                        }
                    } else {
                        // If no language sections found, treat entire content as English
                        const processedEnglish = processTextForTranslation(fullText, 'en');
                        if (processedEnglish) {
                            const cleanEnglish = cleanTextForSSML(processedEnglish);
                            ssmlContent += `<voice name="${englishAnnouncer.voice}"><prosody ${englishAnnouncer.prosody}>${cleanEnglish}</prosody></voice>`;
                            extractedLanguages.push('EN');
                        }
                    }
                    
                    // Extract content for each language section
                    const languageMatches = [...fullText.matchAll(/\n\n=== ([A-Z]+) ===\n\n([\s\S]*?)(?=\n\n=== [A-Z]+ ===\n\n|$)/g)];
                    
                    for (const match of languageMatches) {
                        const isoCode = match[1];
                        const content = match[2].trim();
                        
                        // Find language code by ISO code
                        const langCode = Object.keys(languages).find(code => 
                            languages[code].iso === isoCode
                        );
                        
                        if (langCode && content && languages[langCode]) {
                            // Add announcement
                            ssmlContent += generateAnnouncementSSML(languages[langCode].name);
                            
                            // Add pause after announcement
                            ssmlContent += '<break time="1s"/>';
                            
                            // Add language content
                            ssmlContent += generateLanguageSSML(content, langCode);
                            
                            // Add pause after content
                            ssmlContent += '<break time="2s"/>';
                            
                            extractedLanguages.push(isoCode);
                        }
                    }
                    
                    // Close SSML document
                    ssmlContent += '</speak>';
                    
                    if (extractedLanguages.length === 0) {
                        throw new Error('No content found to export. Please ensure the document has content.');
                    }
                    
                    // Download SSML file
                    const blob = new Blob([ssmlContent], { type: 'text/xml' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'multilingual_document.ssml';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showStatus(`SSML file exported successfully! Languages: ${extractedLanguages.join(', ')}`, 'success');
                });
                
            } catch (error) {
                console.error('Export error:', error);
                showStatus(`Export error: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'üìÑ Export SSML File';
            }
        }

        // Initialize Office
        Office.onReady((info) => {
            if (info.host === Office.HostType.Word) {
                console.log('Add-in loaded in Word');
                loadSavedApiKey();
            }
        });

        // Load saved API key from localStorage
        function loadSavedApiKey() {
            try {
                const savedKey = localStorage.getItem('azureApiKey');
                const savedRegion = localStorage.getItem('azureRegion');
                const saveKeyEnabled = localStorage.getItem('saveApiKey') === 'true';
                
                if (savedKey && saveKeyEnabled) {
                    document.getElementById('azureApiKey').value = savedKey;
                    document.getElementById('saveApiKey').checked = true;
                    showApiStatus('üîë API key loaded from saved settings', 'info');
                }
                
                if (savedRegion) {
                    document.getElementById('azureRegion').value = savedRegion;
                }
            } catch (error) {
                console.log('Could not load saved settings');
            }
        }

        // Save API key if user wants to remember it
        function saveApiKeyIfNeeded() {
            const apiKey = document.getElementById('azureApiKey').value.trim();
            const region = document.getElementById('azureRegion').value;
            const shouldSave = document.getElementById('saveApiKey').checked;
            
            try {
                if (shouldSave && apiKey) {
                    localStorage.setItem('azureApiKey', apiKey);
                    localStorage.setItem('azureRegion', region);
                    localStorage.setItem('saveApiKey', 'true');
                } else {
                    localStorage.removeItem('azureApiKey');
                    localStorage.removeItem('azureRegion');
                    localStorage.removeItem('saveApiKey');
                }
            } catch (error) {
                console.log('Could not save settings');
            }
        }

        function showApiStatus(message, type) {
            const status = document.getElementById('apiStatus');
            status.textContent = message;
            status.className = `api-status ${type}`;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }

        async function startTranslation() {
            const selectedLanguages = getSelectedLanguages();
            
            if (selectedLanguages.length === 0) {
                showStatus('Please select at least one language.', 'error');
                return;
            }

            // Save API key settings
            saveApiKeyIfNeeded();

            const button = document.querySelector('.translate-btn');
            button.disabled = true;
            button.textContent = '‚è≥ Translation in progress...';

            showProgress(true);

            try {
                await Word.run(async (context) => {
                    // Get document content
                    const body = context.document.body;
                    body.load("text,style");
                    await context.sync();

                    const originalText = body.text;
                    
                    if (!originalText.trim()) {
                        throw new Error('The document is empty.');
                    }

                    // Translate for each selected language
                    for (let i = 0; i < selectedLanguages.length; i++) {
                        const langCode = selectedLanguages[i];
                        const langName = languages[langCode].name;
                        
                        updateProgress((i / selectedLanguages.length) * 100, `Translating to ${langName}...`);
                        
                        try {
                            // Process text: remove EN line and adapt URLs
                            const processedText = processTextForTranslation(originalText, langCode);
                            
                            const translatedText = await translateText(processedText, langCode);
                            await insertTranslation(context, translatedText, langName, langCode);
                        } catch (error) {
                            console.error(`Error translating to ${langName}:`, error);
                            await insertTranslation(context, `[Translation error for ${langName}]`, langName, langCode);
                        }
                    }

                    await context.sync();
                    updateProgress(100, 'Translation completed!');
                    
                    setTimeout(() => {
                        showProgress(false);
                        showStatus('Translation successful! The document has been updated.', 'success');
                    }, 1000);
                });

            } catch (error) {
                console.error('Error:', error);
                showStatus(`Error: ${error.message}`, 'error');
                showProgress(false);
            } finally {
                button.disabled = false;
                button.textContent = 'üöÄ Start Translation';
            }
        }

        async function insertTranslation(context, translatedText, langName, langCode) {
            const preserveFormat = document.getElementById('preserveFormat').checked;
            const redText = document.getElementById('redText').checked;
            const newPage = document.getElementById('newPage').checked;

            // Insert page break if requested
            if (newPage) {
                context.document.body.insertBreak(Word.BreakType.page, Word.InsertLocation.end);
            }

            // Insert language title with ISO code
            const titleRange = context.document.body.insertText(`\n\n=== ${languages[langCode].iso} ===\n\n`, Word.InsertLocation.end);
            titleRange.font.bold = true;
            titleRange.font.size = 16;
            titleRange.font.color = '#2196F3';

            // Insert translated text
            const textRange = context.document.body.insertText(translatedText, Word.InsertLocation.end);
            
            if (redText) {
                textRange.font.color = '#FF0000
